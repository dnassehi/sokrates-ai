# Sokrates AI - Medisinsk Anamnese Assistent

Sokrates AI er en intelligent samtaleassistent som hjelper pasienter med √• fylle ut medisinsk anamnese gjennom sokratisk dialog, og gir leger et strukturert grunnlag for videre behandling.

## üåü Funksjoner

### For Pasienter
- **Anonym chat**: Start en samtale uten √• oppgi personlige opplysninger
- **Sokratisk dialog**: AI-assistenten stiller gjennomtenkte sp√∏rsm√•l for √• samle medisinsk informasjon
- **Naturlig samtale**: Fylle ut anamnese gjennom en naturlig dialog i stedet for et tradisjonelt skjema
- **Vurderingssystem**: Mulighet til √• gi tilbakemelding p√• opplevelsen
- **Markdown-formatering**: AI-svar vises med riktig formatering (fet, kursiv, lister, etc.)

### For Leger
- **Dashboard**: Oversikt over alle pasientsesjoner fra din klinikk
- **Strukturert anamnese**: Automatisk generert JSON-strukturert anamnese fra samtalen
- **Komplett samtalehistorikk**: Se hele samtalen mellom pasient og AI
- **Pasientvurderinger**: Se tilbakemeldinger fra pasienter
- **Filtering og s√∏k**: Filtrer sesjoner etter status og andre kriterier
- **Formatert visning**: Anamnese og kommentarer vises med markdown-formatering

## üèóÔ∏è Teknologi-stack

- **Frontend**: React med TanStack Router
- **Backend**: tRPC for type-safe API
- **Database**: PostgreSQL med Prisma ORM
- **AI**: Mistral AI med streaming og JSON-format st√∏tte
- **Autentisering**: JWT tokens med bcrypt for passordhashing
- **Styling**: Tailwind CSS med Typography plugin
- **Markdown-rendering**: markdown-to-jsx for AI-svar og anamnese
- **State Management**: Zustand med persistence
- **Forms**: React Hook Form med Zod validation

## üöÄ Kom i gang

### Forutsetninger
- Node.js (v22 eller nyere)
- Docker og Docker Compose
- Mistral AI API-n√∏kkel

### Installasjon

1. **Klon repositoryet**
   ```bash
   git clone <repository-url>
   cd sokrates-ai
   ```

2. **Installer avhengigheter**
   ```bash
   pnpm install
   ```

3. **Sett opp milj√∏variabler**
   Kopier `.env.example` til `.env` og fyll ut de n√∏dvendige verdiene:
   ```bash
   cp .env.example .env
   ```

   Rediger `.env` og legg til:
   - `MISTRAL_API_KEY`: Din Mistral AI API-n√∏kkel
   - `MISTRAL_MODEL`: Mistral AI modell (f.eks. "mistral-large-latest")
   - `JWT_SECRET`: En lang, tilfeldig streng for JWT-signering (minst 32 tegn)
   og endre `NODE_ENV` fra `development` til `production`

   Legg en kopi av den nye `.env` i `docker`-mappen.
   ```bash
   cp .env /docker/.env
   ```

5. **Start applikasjonen**
   ```bash
   cd docker
   docker-compose up --build -d
   ```

6. **√Öpne nettleseren**
   G√• til `http://localhost:8000` for √• se applikasjonen

### Tilgang til databasen

#### Prisma Studio (Anbefalt)
```bash
npx prisma studio --schema=prisma/schema.local.prisma
```
√Öpne http://localhost:5555 i nettleseren

#### Adminer (Web-basert)
- URL: http://localhost:8080
- Server: `postgres`
- Brukernavn: `postgres`
- Passord: `postgres`
- Database: `app`

#### Direkte PostgreSQL-tilkobling
```bash
psql -h localhost -p 5432 -U postgres -d app
```
Passord: `postgres`

### Demo-konto

Applikasjonen oppretter automatisk en demo-lege-konto:
- **E-post**: `demo@sokrates.no`
- **Passord**: `demo123`
- **Klinikkode**: `DEMO_CLINIC`

## üìã Bruksanvisning

### For Pasienter

1. **Start samtale**: Klikk p√• "Start samtale" p√• forsiden
2. **Chat med Sokrates**: Svar p√• sp√∏rsm√•lene fra AI-assistenten
3. **Fullf√∏r samtalen**: Klikk "Fullf√∏r samtale" n√•r du er ferdig
4. **Gi vurdering**: Vurder opplevelsen din (valgfritt)

### For Leger

1. **Logg inn**: Bruk lege-innlogging p√• forsiden
2. **Dashboard**: Se oversikt over alle sesjoner fra din klinikk
3. **Se detaljer**: Klikk p√• en sesjon for √• se komplett samtale og anamnese
4. **Filtrer**: Bruk filtrene for √• finne spesifikke sesjoner

## üé® Markdown-rendering

Systemet st√∏tter markdown-formatering i alle AI-svar og anamnese-felter for bedre lesbarhet:

### St√∏ttet formatering
- **Fet tekst**: `**tekst**` ‚Üí **tekst**
- **Kursiv tekst**: `*tekst*` ‚Üí *tekst*
- **Overskrifter**: `# Overskrift` ‚Üí `<h1>`
- **Lister**: `- punkt` ‚Üí `<ul><li>`
- **Kode**: `` `kode` `` ‚Üí `<code>`
- **Lenker**: `[tekst](url)` ‚Üí `<a>`

### Implementasjon
- **Frontend**: `markdown-to-jsx` for √• konvertere markdown til React-komponenter
- **Styling**: `@tailwindcss/typography` for konsistent typografi
- **Komponenter**: Chat-meldinger og anamnese-felter rendres automatisk med markdown-st√∏tte

### Streaming og JSON-format
- **Chat-streaming**: Bruker Mistral AI streaming API for bedre ytelse
- **JSON-anamnese**: Automatisk strukturert output med JSON-formatering
- **Sikkerhet**: Ingen data lagres hos Mistral AI
- **Real-time**: Brukere ser svaret bygges opp gradvis

### AI-assistent system-prompt
Systemet bruker en spesifikk prompt for √• fungere som en profesjonell medisinsk sekret√¶r [eksempel]:

```
Du er en profesjonell medisinsk sekret√¶r som jobber for en allmennlege. Din rolle er √• v√¶re en digital assistent som samler inn n√∏dvendig informasjon fra pasienten f√∏r konsultasjonen starter.

**Ditt oppdrag:**
- Forklar at du vil stille noen oppf√∏lgningssp√∏rsm√•l og be pasienten svare p√• de s√• godt vedkommende klarer.
- Be om informert samtykke. Forklar pasienten at interaksjonen blir lagret anonymt.
- Still maks 1‚Äì2 sp√∏rsm√•l om gangen, og vent p√• svar f√∏r du g√•r videre.
- Bruk en varm og profesjonell tone.
- Still relevante sp√∏rsm√•l om:
  - Symptomer
  - N√•r symptomene startet
  - Alvorlighetsgrad
  - Tidligere behandling
  - N√•v√¶rende medisiner
- Bruk gjerne oppf√∏lgingssp√∏rsm√•l for √• f√• fram detaljer.
- N√•r du er ferdig, sp√∏r alltid: ¬´Er det noe mer du √∏nsker √• dele om din helse?¬ª
- Hvis pasienten sier nei eller ikke svarer, lag et kort og konsist notat til legen som oppsummerer situasjonen.
- Minn pasienten p√• √• trykke p√• den gr√∏nne ¬´fullf√∏r¬ª-knappen √∏verst til h√∏yre n√•r samtalen er ferdig.
- Det er meget viktig at du ikke fors√∏ker √• stille diagnoser men overlater refleksjoner rundt dette til legen.

**Eksempelstart:**
"Jeg stiller deg noen flere sp√∏rsm√•l slik at vi kan sikre at all informasjon blir tatt opp. Husk √• trykke p√• den gr√∏nne ¬´fullf√∏r¬ª-knappen √∏verst til h√∏yre."

**Stil og format:**
- Svarene skal v√¶re i dialogformat.
- Bruk fortrinnsvis norsk spr√•k.
- Oppsummering til legen skal v√¶re objektiv og kortfattet.
```

Prompten finnes i `src/server/trpc/procedures/sendChatMessage.ts`.

## üóÑÔ∏è Database-struktur

### Hovedmodeller

- **Doctor**: Lege-kontoer med e-post, passord og klinikkode
- **Session**: Pasientsesjoner med status og tidsstempler
- **Message**: Individuelle meldinger i samtalen
- **Anamnesis**: Strukturert medisinsk anamnese generert fra samtalen
- **Rating**: Pasientvurderinger av opplevelsen

### Anamnese-struktur

Hver fullf√∏rte samtale genererer en strukturert anamnese med f√∏lgende felter:
- Hovedplage
- Tidligere sykdommer
- Medisinering
- Allergier
- Familiehistorie
- Sosial livsstil
- ROS (Review of Systems)
- Pasientm√•l
- Fri oppsummering

## üîí Sikkerhet

- **Anonym pasientchat**: Pasienter trenger ikke oppgi personlige opplysninger
- **JWT-autentisering**: Sikker autentisering for leger
- **Passordhashing**: Bcrypt brukes for sikker lagring av passord
- **Klinikk-isolasjon**: Leger ser kun sesjoner fra sin egen klinikk
- **Token-validering**: Alle API-kall valideres med JWT-tokens

## üìë Mistral AI-brukspolicy

- Alle kall til Mistral AI skjer server-side og API-n√∏klene eksponeres aldri i
  klienten.
- N√∏klene lagres kun i milj√∏variabler og blir ikke lagret i databasen.
- Foresp√∏rsler inkluderer anonym sesjons-ID i henhold til
  retningslinjene.
- Les mer i [Mistral AI Terms](https://mistral.ai/terms) og [Data Processing Addendum](https://mistral.ai/terms#data-processing-addendum).

## üß™ Testing

Applikasjonen inkluderer demo-data for testing:
- Demo-lege-konto opprettet automatisk
- Eksempel-sesjon med komplett samtale og anamnese
- Pasientvurdering inkludert

## üìù API-endepunkter

### Pasient-endepunkter
- `createChatSession`: Opprett ny chat-sesjon
- `sendChatMessage`: Send melding og f√• AI-respons (streaming)
- `completeChatSession`: Fullf√∏r sesjon og generer anamnese
- `submitRating`: Send pasientvurdering

### Lege-endepunkter
- `doctorLogin`: Lege-innlogging
- `doctorRegister`: Registrer ny lege
- `getDoctorSessions`: Hent sesjoner for lege (med paginering)
- `getSessionDetails`: Hent komplett sesjondetaljer

## üîÑ Utvikling

### Kj√∏re i utviklingsmodus
```bash
pnpm run dev
```

### Bygge for produksjon
```bash
pnpm run build
```

### Database-migrering
Databasen oppdateres automatisk ved oppstart. Ingen manuelle migreringer n√∏dvendig.

## üöÄ Deployment

### Docker Compose (Lokal/Development)
```bash
cd docker
docker-compose up --build -d
```

### DigitalOcean App Platform (Production)

#### Konfigurasjon
- **app.yaml**: Hovedkonfigurasjon for DigitalOcean med managed database
- **app.docker.yaml**: Alternativ konfigurasjon for Docker-basert deployment

#### Database-konfigurasjon
```prisma
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  // For Docker/local development:
  // url      = "postgresql://postgres:postgres@postgres/app"
  // For DigitalOcean/production:
  url      = env("DATABASE_URL")
}
```

#### Bytte mellom Docker og Production
1. **Docker-modus**: Uncomment Docker URL og comment ut env-versjonen
2. **Production-modus**: Uncomment env-versjonen og comment ut Docker URL

#### Environment Variables for DigitalOcean
```
NODE_ENV=production
BASE_URL=https://sokrates.chat
BASE_URL_OTHER_PORT=https://sokrates.chat
ADMIN_PASSWORD=din-admin-passord
MISTRAL_API_KEY=din-mistral-api-n√∏kkel
MISTRAL_MODEL=mistral-large-latest
JWT_SECRET=din-jwt-secret
DATABASE_URL=${db.DATABASE_URL}
```

#### Deploy til DigitalOcean
```bash
# Via CLI
doctl apps create --spec app.yaml

# Eller via dashboard
# 1. G√• til DigitalOcean App Platform
# 2. Velg "Create App"
# 3. Velg "App Spec"
# 4. Lim inn innholdet fra app.yaml
```

## ü§ù Bidrag

1. Fork repositoryet
2. Opprett en feature-branch (`git checkout -b feature/AmazingFeature`)
3. Commit endringene dine (`git commit -m 'Add some AmazingFeature'`)
4. Push til branchen (`git push origin feature/AmazingFeature`)
5. √Öpne en Pull Request

## üìÑ Lisens

Dette prosjektet er lisensiert under MIT-lisensen.

## üÜò Support

For sp√∏rsm√•l eller problemer, vennligst opprett en issue i GitHub-repositoryet.
